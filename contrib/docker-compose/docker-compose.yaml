version: '3.7'
services:

  # RabbitMQ Instance
  rabbitmq:
    image: bitnami/rabbitmq:latest
    ports:
    - 15672:15672

  postgres:
    image: bitnami/postgresql
    environment:
      ALLOW_EMPTY_PASSWORD: 'yes'
      POSTGRESQL_DATABASE: media
  
  minio:
    image: minio/minio
    command:
    - server
    - /data
    volumes:
    - /data
    environment:
      MINIO_ACCESS_KEY: "CHANGEME"
      MINIO_SECRET_KEY: "CHANGEME"

  ###########################################
  # Our Services
  converter:
    image: jaredallard/triton-converter:prod
    environment:
      MEDIA: 'http://twilight:8001'
      MINIO: 'http://minio:9000'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
    volumes:
    - ./config:/mnt/config

  downloader:
    image: jaredallard/triton-downloader:prod
    environment:
      MINIO: 'http://minio:9000'
      MEDIA: 'http://twilight:8001'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
      ALLOW_FILE_URLS: 'true'
    volumes:
    - ./config:/mnt/config
    - /tmp/Bunny.mkv:/tmp/Bunny.mkv

  events:
    image: jaredallard/triton-events:prod
    environment:
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      POSTGRES: 'postgres'
      NO_TRELLO: 'true' 
      NODE_ENV: production
    command: events
    ports:
    - 3401:3401 # Webhook
    volumes:
    - ./config:/mnt/config

  twilight:
    image: jaredallard/triton-twilight:prod
    environment:
      MINIO: 'http://minio:9000'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
    command: twilight
    volumes:
    - ./config:/mnt/config
