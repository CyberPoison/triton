version: '3.7'
services:

  # RabbitMQ Instance
  rabbitmq:
    image: bitnami/rabbitmq:latest
    ports:
    - 5672:5672
    - 15672:15672
  
  minio:
    image: minio/minio
    command:
    - server
    - /data
    ports:
    - 9000:9000
    environment:
      MINIO_ACCESS_KEY: "AKIAIOSFODNN7EXAMPLE"
      MINIO_SECRET_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

  ###########################################
  # Our Services
  converter:
    image: jaredallard/triton-converter:prod
    environment:
      MEDIA: 'http://twilight:8001'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
    volumes:
    - ./config:/mnt/config

  downloader:
    image: jaredallard/triton-downloader:prod
    environment:
      MINIO: 'http://minio:9000'
      MEDIA: 'http://twilight:8001'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
    volumes:
    - ./config:/mnt/config

  events:
    image: jaredallard/triton-events:prod
    environment:
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      POSTGRES: 'postgres'
      NO_WEBHOOK: 'true'
      NODE_ENV: production
    command: events
    ports:
    - 3401:3401 # Webhook
    volumes:
    - ./config:/mnt/config

  twilight:
    image: jaredallard/triton-twilight:prod
    environment:
      MINIO: 'http://minio:9000'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      NODE_ENV: production
    command: twilight
    ports:
    - 8001:8001
    volumes:
    - ./config:/mnt/config
