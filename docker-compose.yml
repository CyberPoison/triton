version: '3.7'
services:

  # RabbitMQ Instance
  rabbitmq:
    image: bitnami/rabbitmq:latest
    ports:
    - 5672:5672
    - 15672:15672

  postgres:
    image: bitnami/postgresql
    environment:
      ALLOW_EMPTY_PASSWORD: 'yes'
      POSTGRESQL_DATABASE: media
    ports:
    - 5432:5432
  
  minio:
    image: minio/minio
    command:
    - server
    - /data
    ports:
    - 9000:9000
    environment:
      MINIO_ACCESS_KEY: "AKIAIOSFODNN7EXAMPLE"
      MINIO_SECRET_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

  ###########################################
  # Our Services
  converter:
    image: jaredallard/triton-converter:prod
    environment:
      MEDIA: 'http://twilight:8001'
      MINIO: 'http://minio:9000'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      POSTGRES: 'postgres'
      CONFIG_ENV: production
    volumes:
    - ./config:/mnt/config

  downloader:
    image: jaredallard/triton-downloader:prod
    environment:
      MINIO: 'http://minio:9000'
      MEDIA: 'http://twilight:8001'
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      CONFIG_ENV: production
      ALLOW_FILE_URLS: 'true'
    volumes:
    - ./config:/mnt/config
    - /tmp/Bunny.mkv:/tmp/Bunny.mkv

  events:
    image: jaredallard/triton-events:prod
    environment:
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      POSTGRES: 'postgres'
      NO_TRELLO: 'true' 
      CONFIG_ENV: production
    command: events
    ports:
    - 3401:3401 # Webhook
    volumes:
    - ./config:/mnt/config

  beholder:
    image: jaredallard/triton-beholder:prod
    environment:
      RABBITMQ: 'amqp://user:bitnami@rabbitmq'
      POSTGRES: 'postgres'
      CONFIG_ENV: production
    command: beholder
    volumes:
    - ./config:/mnt/config

  twilight:
    image: jaredallard/triton-twilight-go
    environment:
      TWILIGHT_STORAGE_PROVIDER: s3
      TWILIGHT_S3_ENDPOINT: 'http://minio:9000'
      TWILIGHT_S3_ACCESS_KEY: 'AKIAIOSFODNN7EXAMPLE'
      TWILIGHT_S3_SECRET_KEY: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
      TWILIGHT_S3_BUCKET: 'triton-media'
      TWILIGHT_RABBITMQ_ENDPOINT: 'amqp://user:bitnami@rabbitmq'
      PORT: '8001'
    command: twilight
    ports:
    - 8001:8001
  
  identifier:
    image: jaredallard/triton-identifier
    environment:
      IDENTIFIER_S3_ENDPOINT: 'http://minio:9000'
      IDENTIFIER_S3_ACCESS_KEY: 'AKIAIOSFODNN7EXAMPLE'
      IDENTIFIER_S3_SECRET_KEY: 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
      IDENTIFIER_S3_BUCKET: 'triton-media'
      IDENTIFIER_POSTGRES_ENDPOINT: 'postgres'
      IDENTIFIER_RABBITMQ_ENDPOINT: 'amqp://user:bitnami@rabbitmq'
    command: identifier